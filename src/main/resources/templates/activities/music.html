<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Challenge - EduLink UANE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body class="bg-light">

    <a th:href="@{/dashboard}" class="btn-back-menu shadow-sm">
        <i class="bi bi-arrow-left-circle-fill"></i> SALIR DEL JUEGO
    </a>

    <img th:src="@{/logo_universidad.png}" alt="Logo UANE" class="uni-logo-fixed">

    <div class="container py-5 mt-4">
        <div class="row g-5">
            
            <div class="col-lg-7">
                <div class="mission-badge">Misión: Escucha con atención</div>
                <div class="video-wrapper shadow mb-4">
                    <div class="video-overlay" id="blocker"></div> 
                    <div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0;">
                        <div id="player" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn-repeat shadow" onclick="replaySegment()">
                        <i class="bi bi-arrow-counterclockwise"></i> ESCUCHAR DE NUEVO
                    </button>
                </div>
            </div>
            
            <div class="col-lg-5">
                <div class="login-card shadow-lg text-start w-100 py-4 px-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-headphones me-2" style="color: var(--uane-red); font-size: 1.5rem;"></i>
                        <h4 class="mb-0 card-title-game" th:text="${challenge.title}">Challenge</h4>
                    </div>
                    
                    <p class="lead fw-bold mb-4" id="question-text" th:text="${challenge.questionText}" style="color: var(--uane-dark);">
                        Espera a que la música comience...
                    </p>
                    
                    <div id="options-container" style="display: none;">
                        <button th:each="opt : ${options}" 
                                class="option-btn" 
                                th:onclick="checkAnswer(this, [[${challenge.correctAnswer}]])">
                            <span class="badge bg-light text-dark me-2"></span>
                            <span th:text="${opt}">Opción</span>
                        </button>
                    </div>

                    <div id="next-container" style="display: none;" class="mt-4 text-center animate__animated animate__fadeInUp">
                        <div class="alert alert-success border-0 shadow-sm rounded-4 py-3">
                            <h5 class="mb-2">¡EXCELENTE TRABAJO!</h5>
                            <p class="mb-0 small">+10 puntos acumulados</p>
                        </div>
                        <a th:href="@{/activity/music(index=${nextIndex})}" class="btn btn-game w-100 mt-2">
                            SIGUIENTE CANCIÓN <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <script th:inline="javascript">
        // [Aquí va todo tu script de YouTube API y checkAnswer sin cambios, ya que los IDs se mantienen]
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        var startTime = [[${challenge.startTime != null ? challenge.startTime : 0}]];
        var pauseTime = [[${challenge.pauseTime}]];
        var checkInterval;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '100%',
                videoId: [[${challenge.mediaId}]],
                playerVars: {
                    'start': startTime,
                    'autoplay': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'modestbranding': 1,
                    'rel': 0,
                    'iv_load_policy': 3
                },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function startMonitoring() {
            clearInterval(checkInterval);
            checkInterval = setInterval(function() {
                var currentTime = player.getCurrentTime();
                if (currentTime >= pauseTime) {
                    player.pauseVideo();
                    document.getElementById('options-container').style.display = 'block';
                    document.getElementById('question-text').classList.add('text-danger', 'fw-bold');
                    clearInterval(checkInterval);
                }
            }, 500);
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                startMonitoring();
            } else {
                clearInterval(checkInterval);
            }
        }

        function replaySegment() {
            player.seekTo(startTime);
            player.playVideo();
            document.getElementById('options-container').style.display = 'none';
            document.getElementById('question-text').classList.remove('text-danger', 'fw-bold');
        }

        function checkAnswer(btn, correct) {
            const csrfToken = document.getElementById('csrfToken').value;

            if (btn.innerText.includes(correct)) {
                btn.classList.add('correct');
                document.getElementById('next-container').style.display = 'block';
                
                fetch('/api/progress/add-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    }
                })
                .then(response => response.json())
                .catch(err => console.error(err));

                var btns = document.getElementsByClassName('option-btn');
                for(var i=0; i<btns.length; i++) btns[i].disabled = true;
            } else {
                btn.classList.add('incorrect');
                setTimeout(() => btn.classList.remove('incorrect'), 1000);
            }
        }
    </script>
</body>
</html>